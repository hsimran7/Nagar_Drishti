{% extends "government/layout.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div style="padding: 20px; background-color: #f8fafc; min-height: 100vh;">
    <div style="margin-bottom: 25px;">
        <h2 style="font-weight: 800; color: #1e293b; margin: 0;">City Command Center</h2>
        <p style="color: #64748b; margin: 5px 0 0 0;">Live Intelligence & Geospatial Analytics</p>
    </div>

    <div style="background: white; border-left: 5px solid #ef4444; padding: 20px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);">
        <h3 style="color: #ef4444; margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 10px;">
            <span>ðŸ¤–</span> AI Critical Path (Unresolved High Priority)
        </h3>
        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            {% for p in ai_priority %}
            <div style="background: #fef2f2; padding: 10px 15px; border-radius: 8px; font-size: 0.9rem; border: 1px solid #fee2e2;">
                <strong>{{ p.issue }}</strong> @ {{ p.address }}
            </div>
            {% else %}
            <p style="color: #64748b; font-size: 0.9rem; margin: 0;">âœ… All high-priority issues are currently clear.</p>
            {% endfor %}
        </div>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px;">
        
        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);">
            <h3 style="margin-top: 0; font-size: 1rem; color: #475569;">Live Problem Hotspots</h3>
            <div id="map" style="height: 400px; width: 100%; border-radius: 12px; border: 1px solid #e2e8f0;"></div>
        </div>

        <div style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);">
            <h3 style="margin-top: 0; font-size: 1rem; color: #475569;">Total Complaints by Neighborhood</h3>
            <canvas id="mainAreaChart"></canvas>
        </div>
    </div>

    <div id="drillDownContainer" style="display: none; margin-top: 30px; background: white; padding: 30px; border-radius: 16px; border: 2px dashed #6366f1;">
        <h3 id="drillDownTitle" style="color: #4338ca; margin-top: 0; text-align: center;">Issue Breakdown</h3>
        <div style="max-width: 350px; margin: 0 auto;">
            <canvas id="drillDownChart"></canvas>
        </div>
    </div>
</div>

<script>
    // 1. SAFE DATA LOADING
    // Using JSON.parse to ensure characters like newlines don't break JS
    const activeReports = JSON.parse('{{ active_complaints | tojson | safe }}');
    const allReports = JSON.parse('{{ all_complaints | tojson | safe }}');

    // 2. COORDINATE CONFIG
    const areaCoords = {
        "Sardar Nagar": [30.915, 75.865],
        "Basti Jodhewal": [30.932, 75.875],
        "Haibowal": [30.920, 75.835],
        "Samrala Chownk": [30.905, 75.885],
        "Model Town": [30.890, 75.845],
        "Default": [30.901, 75.857]
    };

    // 3. MAP LOGIC
    var map = L.map('map').setView([30.901, 75.857], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    activeReports.forEach(r => {
        let coords = areaCoords["Default"];
        const addr = (r.address || "").toLowerCase();
        for (const [name, loc] of Object.entries(areaCoords)) {
            if (addr.includes(name.toLowerCase())) { coords = loc; break; }
        }
        // Jitter markers so they don't stack perfectly
        const lat = coords[0] + (Math.random() - 0.5) * 0.01;
        const lon = coords[1] + (Math.random() - 0.5) * 0.01;
        
        L.circleMarker([lat, lon], {
            radius: 8,
            color: r.severity === 'High' ? '#ef4444' : '#3b82f6',
            fillColor: r.severity === 'High' ? '#ef4444' : '#3b82f6',
            fillOpacity: 0.6
        }).addTo(map).bindPopup(`<b>${r.issue}</b><br>${r.address}`);
    });

    // 4. MAIN CHART LOGIC
    const knownAreas = ["Sardar Nagar", "Basti Jodhewal", "Haibowal", "Samrala Chownk", "Model Town"];
    const areaCounts = {};
    knownAreas.forEach(a => areaCounts[a] = 0);

    allReports.forEach(r => {
        const addr = (r.address || "").toLowerCase();
        knownAreas.forEach(a => {
            if (addr.includes(a.toLowerCase())) areaCounts[a]++;
        });
    });

    const ctx = document.getElementById('mainAreaChart').getContext('2d');
    const mainChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(areaCounts),
            datasets: [{
                label: 'Total Requests',
                data: Object.values(areaCounts),
                backgroundColor: '#6366f1',
                borderRadius: 6
            }]
        },
        options: {
            responsive: true,
            onClick: (e, elements) => {
                if (elements.length > 0) {
                    const areaName = mainChart.data.labels[elements[0].index];
                    showDrillDown(areaName);
                }
            }
        }
    });

    // 5. DRILL DOWN LOGIC
    let drillChartInstance = null;
    function showDrillDown(areaName) {
        document.getElementById('drillDownContainer').style.display = 'block';
        document.getElementById('drillDownTitle').innerText = `Problem Breakdown: ${areaName}`;

        const issues = {};
        allReports.forEach(r => {
            if (r.address.toLowerCase().includes(areaName.toLowerCase())) {
                issues[r.issue] = (issues[r.issue] || 0) + 1;
            }
        });

        if (drillChartInstance) drillChartInstance.destroy();
        const dCtx = document.getElementById('drillDownChart').getContext('2d');
        drillChartInstance = new Chart(dCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(issues),
                datasets: [{
                    data: Object.values(issues),
                    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']
                }]
            }
        });
        document.getElementById('drillDownContainer').scrollIntoView({ behavior: 'smooth' });
    }
</script>

{% endblock %}
