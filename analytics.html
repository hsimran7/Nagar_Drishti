{% extends "government/layout.html" %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="page-header" style="margin-bottom: 30px;">
    <h2 style="font-size: 2.2rem; font-weight: 800;">City Intelligence Hub</h2>
    <p style="color: var(--secondary);">Interactive Map and Drill-down Analytics.</p>
</div>

<div class="priority-card" style="background: #fff5f5; border: 1px solid #fee2e2; padding: 20px; border-radius: 20px; margin-bottom: 40px; box-shadow: var(--shadow);">
    <h3 style="color: #dc2626; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
        <span style="background: #fee2e2; padding: 8px; border-radius: 12px;">ðŸ¤–</span> AI Critical Path
    </h3>
    {% for p in ai_priority %}
    <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #f1f5f9;">
        <span><strong>{{ p.issue }}</strong> - {{ p.address }}</span>
        <a href="{{ url_for('resolve', id=p.id) }}" class="btn-resolve" style="background: #4f46e5; color: white; padding: 8px 15px; border-radius: 8px; text-decoration: none; font-size: 0.85rem;">Resolve Now</a>
    </div>
    {% endfor %}
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
    <div class="chart-wrapper" style="background: white; padding: 25px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: var(--shadow);">
        <h3 style="margin-bottom: 15px;">Live Problem Hotspots</h3>
        <div id="map" style="height: 400px; border-radius: 16px;"></div>
    </div>

    <div class="chart-wrapper" style="background: white; padding: 25px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: var(--shadow);">
        <h3>Total Complaints by Area</h3>
        <p style="font-size: 0.8rem; color: #64748b; margin-bottom: 15px;">Click on a bar to see detailed issues for that area.</p>
        <canvas id="mainAreaChart" style="max-height: 350px;"></canvas>
    </div>
</div>

<div id="drillDownContainer" class="chart-wrapper" style="display: none; background: #f8fafc; padding: 30px; border-radius: 24px; border: 2px dashed #4f46e5; margin-bottom: 30px;">
    <h3 id="drillDownTitle" style="color: #4f46e5; margin-bottom: 20px;">Detailed Issues in [Area]</h3>
    <canvas id="drillDownChart" style="max-height: 350px;"></canvas>
</div>

<script>
    // Safe data transfer
    const reports = {{ complaints | tojson | safe }};
    const knownAreas = ["Sardar Nagar", "Basti Jodhewal", "Haibowal", "Samrala Chownk", "Model Town"];

    // 1. PROCESS DATA FOR MAP & MAIN CHART
    const areaCounts = {};
    knownAreas.forEach(area => areaCounts[area] = 0);
    
    reports.forEach(r => {
        const addr = (r.address || "").toLowerCase();
        knownAreas.forEach(area => {
            if (addr.includes(area.toLowerCase())) areaCounts[area]++;
        });
    });

    // 2. INITIALIZE LIVE MAP
    // Note: Coordinates centered on Ludhiana context as per your database snippets
    var map = L.map('map').setView([30.901, 75.857], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    reports.forEach(r => {
        // Random scattering for visualization (normally would use Lat/Lng from DB)
        var lat = 30.901 + (Math.random() - 0.5) * 0.04;
        var lon = 75.857 + (Math.random() - 0.5) * 0.04;
        var color = r.severity === 'High' ? 'red' : 'blue';
        L.circleMarker([lat, lon], { radius: 6, color: color, fillOpacity: 0.6 }).addTo(map).bindPopup(r.issue);
    });

    // 3. RENDER MAIN AREA CHART
    let drillDownChartInstance = null;
    const mainChart = new Chart(document.getElementById('mainAreaChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(areaCounts),
            datasets: [{
                label: 'Number of Complaints',
                data: Object.values(areaCounts),
                backgroundColor: '#4f46e5',
                borderRadius: 8
            }]
        },
        options: {
            onClick: (event, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const areaName = mainChart.data.labels[index];
                    showDrillDown(areaName);
                }
            }
        }
    });

    // 4. DRILL DOWN LOGIC
    function showDrillDown(areaName) {
        const drillContainer = document.getElementById('drillDownContainer');
        const drillTitle = document.getElementById('drillDownTitle');
        drillContainer.style.display = 'block';
        drillTitle.innerText = `Problem Breakdown: ${areaName}`;

        const issueMap = {};
        reports.forEach(r => {
            if (r.address.toLowerCase().includes(areaName.toLowerCase())) {
                issueMap[r.issue] = (issueMap[r.issue] || 0) + 1;
            }
        });

        if (drillDownChartInstance) drillDownChartInstance.destroy();

        drillDownChartInstance = new Chart(document.getElementById('drillDownChart'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(issueMap),
                datasets: [{
                    data: Object.values(issueMap),
                    backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#94a3b8']
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });
        drillContainer.scrollIntoView({ behavior: 'smooth' });
    }
</script>

{% endblock %}